<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>XRP Portfolio Manager</title>
  <style>
    :root{ --bg:#0e1117; --card:#161b22; --text:#e6edf3; --muted:#8b949e; --radius:16px; --cardBorder:#22314b; --inputBg:#0b1220; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:560px;margin:0 auto;padding:12px 12px 24px}
    .row{display:flex;gap:10px}
    .row.wrap{flex-wrap:wrap}
    .card{background:var(--card);border-radius:var(--radius);padding:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0b1220;border:1px solid #263041;padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .title{font-size:18px;font-weight:700;margin:0 0 8px}
    .subtitle{font-size:12px;color:var(--muted);margin-top:2px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .tile{flex:1;min-width:46%;padding:12px;border-radius:14px;background:#0f1726;border:1px solid #22314b}
    .tile .label{font-size:12px;color:var(--muted)}
    .tile .val{font-size:18px;font-weight:700;margin-top:4px}
    .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    button{border:0;border-radius:12px;padding:8px 10px;background:#0b1220;color:var(--text);border:1px solid #2a3a59;font-weight:600;cursor:pointer}
    .micro{font-size:11px; padding:4px 8px; border-radius:8px; line-height:1}
    input[type="text"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3a59;background:#0b1220;color:var(--text);font-size:16px}
    .mono{font-variant-numeric:tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .kpi{background:#0f1726;border:1px solid #22314b;border-radius:14px;padding:10px}
    .kpi .k{font-size:12px;color:var(--muted);margin-bottom:4px}
    .section{margin-top:12px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .slider-wrap{background:#0f1726;border:1px solid #22314b;border-radius:14px;padding:10px}
    .slider-head{display:flex;justify-content:space-between;align-items:center}
    .slider-head .tag{font-size:12px;color:var(--muted)}
    input[type="range"]{-webkit-appearance:none;width:100%;height:28px;background:transparent;margin-top:6px}
    input[type="range"]::-webkit-slider-runnable-track{height:6px;background:#1f2a44;border-radius:10px}
    input[type="range"]::-moz-range-track{height:6px;background:#1f2a44;border-radius:10px}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:#2ea043;border:2px solid #0b1220;margin-top:-8px}
    input[type="range"]::-moz-range-thumb{width:22px;height:22px;border-radius:50%;background:#2ea043;border:2px solid #0b1220}
    #priceSliderArea{display:none;margin-top:8px}
    #quickPrice{gap:4px}
    #quickPrice button{padding:4px 6px;font-size:12px;border-radius:10px}
    .toolbar{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  
    .kpi.portfolio-tight{ margin-right:-6px; }
    #inpPortfolioVal{ margin:0; }
    
    .ltv-inline{ display:inline-flex; gap:3px; margin-left:6px; vertical-align:middle }
    .micro.micro-ltv{ padding:0 4px !important; border-radius:6px !important; font-size:11px !important }
    
    .inline-pair{ display:flex; justify-content:space-between; align-items:center; gap:8px }
    
    .pv-inline{ display:flex; align-items:center; gap:6px }
    .pv-input-wrap{ flex:1 }
    .pv-inline input{ width:100% }
    
    #apy{ text-align:center; width:100%; display:flex; align-items:center; justify-content:center; font-weight:600; }
    
    .apy-btn{ color:#cfd6e4 !important; border-color:#2a3a59 !important; background:#0b1220 !important; padding:2px 5px !important; font-size:11px !important }
    
    .apy-controls{ display:inline-flex; gap:4px; flex-wrap:nowrap; white-space:nowrap; vertical-align:middle }
    
    .pill-btn{ 
  padding:2px 8px !important; 
  border-radius:999px !important; 
  background:#0b1220 !important; 
  border:1px solid #2a3a59 !important; 
  line-height:1; 
  font-size:11px !important;
  color:#cfd6e4 !important;
}
.pill-btn:focus, .pill-btn:hover{ color:#dfe6f4 !important; border-color:#34496f !important; }
.pill-btn.btn-white{ color:#ffffff !important; }.apy-btn{ color:#cfd6e4 !important; } /* pale off-white for APY and other small buttons */
    .btn-white{ color:#ffffff !important; }
    </style>
</head>
<body>
  <div class="container">
    <!-- TradingView Chart: XRPUSD -->
    
    <style>
      .tv-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
      .tv-btns{display:flex;gap:6px}
      .tv-btn{background:#0b1220;border:1px solid #22314b;border-radius:10px;padding:6px 10px;font-size:12px;color:#e6edf3;cursor:pointer}
      .tv-btn:active{transform:translateY(1px)}
    </style>
    <div class="card" style="margin-bottom:8px">
      <div class="tv-card-header">
        <div class="title">XRPUSD — TradingView</div>
        <div class="tv-btns">
          <button class="tv-btn" id="btn_pair">$/€</button>
          <button class="tv-btn" id="btn_usd_1.2k">$1.2k</button>
          <button class="tv-btn" id="btn_eur_1.2k">€1.2k</button>
        </div>
      </div>
      <div id="tv_xrp_container" style="height:420px; width:100%"></div>
    </div>
    

    <!-- Live price tiles -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="subtitle" id="source">source: —</div>
    <button id="refreshBtn" class="micro apy-btn">⟳</button>
      </div>
      <div class="grid section">
        <div class="tile">
          <div class="label">XRPEUR</div>
          <div class="val mono" id="xrpEur">€0.00</div>
        </div>
        <div class="tile">
          <div class="label">XRPUSD</div>
          <div class="val mono" id="xrpUsdTile">$0.00</div>
        </div>
        <div class="tile">
          <div class="label">XRPEUR × 1.200</div>
          <div class="val mono" id="eurHeld">€0</div>
        </div>
        <div class="tile">
          <div class="label">XRPUSD × 1.200</div>
          <div class="val mono" id="usdHeld">$0</div>
        </div>
      </div>
    </div>

    <!-- Portfolio Manager -->
    <div class="card section">
      <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:8px"><h3 class="title" style="margin:0">XRP Portfolio Manager</h3><div class="pill" id="now">—</div></div>

      <div class="section">
        <div class="row" style="gap:8px;margin-top:6px">
          <div style="flex:1.2">
            <input id="priceOverride" type="text" inputmode="numeric" placeholder="$0">
          </div>
          <div class="toolbar">
            <button id="applyOverride" style="display:none">Apply</button>
            <div id="priceShortBox" style="display:flex;flex-direction:column;line-height:1.1;min-width:58px"><span id="priceShort" class="subtitle mono"></span><span id="priceShortEUR" class="subtitle mono"></span></div>
            <button id="togglePriceSlider">Slider</button>
            <button id="clearOverride">Use live</button>
          </div>
        </div>

        <!-- Quick price presets -->
        <div class="btns" id="quickPrice">
          <button data-price="589">$589</button>
          <button data-price="1000">$1k</button>
          <button data-price="2500">$2.5k</button>
          <button data-price="5000">$5k</button>
          <button data-price="10000">$10k</button>
          <button data-price="50000">$50k</button>
          <button data-price="100000">$100k</button>
          <button data-price="1000000">$1m</button>
        </div>

        <!-- Log scale price slider -->
        <div id="priceSliderArea" class="slider-wrap">
          <div class="slider-head">
            <div>
              <div class="tag">Price Override Slider (log)</div>
              <div class="mono" id="priceSliderVal">$0</div>
            </div>
          </div>
          <input id="priceSlider" type="range" min="0" max="1000" step="1" value="500">
        </div>
      </div>

      <!-- KPI inputs -->
      <div class="kpis">
        <div class="kpi portfolio-tight">
          <div class="k" style="display:flex;justify-content:space-between;align-items:center">Portfolio Value <span class="subtitle mono" id="pvShortTop"></span></div>
          <div class="v"><input class="mono" id="inpPortfolioVal" type="text" placeholder="$0"></div>
        </div>
        <div class="kpi">
          <div class="k" style="display:flex;justify-content:space-between;align-items:center;gap:6px">
            APY <span><button id="apy5" class="micro apy-btn pill-btn">5%</button> <button id="apy7_5" class="micro apy-btn">7.5%</button> <button id="apy10" class="micro apy-btn">10%</button> <button id="apyReset" class="micro apy-btn">r</button></span>
          </div>
          <div class="v mono" id="apy">0%</div>
        </div>
      </div>

      <div class="split section">
        <div class="slider-wrap">
          <div class="slider-head">
            <div>
              <div class="tag">XRP Allocated Interest/year</div>
              <div class="inline-pair"><div class="mono" id="intXrp">0 XRP</div><div class="subtitle mono" id="intUsd">$0</div></div>
            </div>
          </div>
          <input id="interestSlider" type="range" min="0" max="1200" step="100" step="100" value="1000">
          <div class="subtitle mono" id="interestEarned">Interest: $0</div>
        </div>

        <div class="slider-wrap">
          <div class="slider-head">
            <div>
              <div class="tag">Loan. LTV%: <span class="ltv-inline"><button class="micro micro-ltv apy-btn" data-ltv="0.30">30</button><button class="micro micro-ltv apy-btn" data-ltv="0.60">60</button><button class="micro micro-ltv apy-btn" data-ltv="0.90">90</button></span></div>
              <div class="inline-pair"><div class="mono" id="loanXrp">0 XRP</div><div class="subtitle mono" id="loanUsd">$0</div></div>
            </div>
          </div>
          <input id="loanSlider" type="range" min="0" max="1200" step="100" step="100" value="200">
          <div class="subtitle mono" id="loanAmount">Loan: $0</div>
        </div>
      </div>

      <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px"><div class="toolbar"><button id="showMS" class="micro apy-btn">show minute/second</button></div><div class="toolbar"><button data-xrp="300" id="qx5" class="micro apy-btn">300 XRP</button> <button data-xrp="600" id="qx10" class="micro apy-btn">600 XRP</button> <button data-xrp="900" id="qx15" class="micro apy-btn">900 XRP</button></div></div>

      <div class="kpis section" id="earningsKpis">
        <div class="kpi">
          <div class="k">Monthly Earnings</div>
          <div class="v"><input class="mono" id="inpMonthly" type="text" placeholder="$0"></div>
        </div>
        <div class="kpi">
          <div class="k">Weekly Earnings</div>
          <div class="v"><input class="mono" id="inpWeekly" type="text" placeholder="$0"></div>
        </div>
        <div class="kpi">
          <div class="k">Daily Earnings</div>
          <div class="v"><input class="mono" id="inpDaily" type="text" placeholder="$0"></div>
        </div>
        <div class="kpi">
          <div class="k">Hourly Earnings</div>
          <div class="v"><input class="mono" id="inpHourly" type="text" placeholder="$0"></div>
        </div>
        <div class="kpi" id="kpiMinutely" style="display:none">
          <div class="k">Minutely Earnings</div>
          <div class="v"><input class="mono" id="inpMinutely" type="text" placeholder="$0"></div>
        </div>
        <div class="kpi" id="kpiSecondly" style="display:none">
          <div class="k">Secondly Earnings</div>
          <div class="v"><input class="mono" id="inpSecondly" type="text" placeholder="$0"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Helpers
    const el = id => document.getElementById(id);
    const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
    function parseMoneyStrict(s){
      if(s===undefined || s===null) return NaN;
      const raw = String(s).replace(/[\$€\s,\.]/g,'').replace(/[^\d-]/g,'');
      if(!raw || raw==='-') return NaN;
      return Number(raw);
    }
    function fmtUSDintDot(n){
      const i = Math.round(Number(n)||0);
      const sign = i<0?'-':'';
      const s = String(Math.abs(i));
      let out='';
      for(let j=0;j<s.length;j++){
        const idx = s.length - j;
        out = s[idx-1] + out;
        if(j%3===2 && idx>1) out = '.' + out;
      }
      return sign + '$' + out;
    }
    const fmtUSD  = (n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}).format(n||0);
    const fmtEUR  = (n)=> new Intl.NumberFormat('nl-NL',{style:'currency',currency:'EUR',maximumFractionDigits:2}).format(n||0);
    const fmtEUR0 = (n)=> new Intl.NumberFormat('nl-NL',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Math.round(n||0));
    function fmtShortNoDec(n, symbol){
      const sign = (n||0) < 0 ? '-' : '';
      const abs = Math.abs(Number(n)||0);
      const units = [
        {v:1e15,s:'q'},
        {v:1e12,s:'t'},
        {v:1e9,s:'b'},
        {v:1e6,s:'m'},
        {v:1e3,s:'k'}
      ];
      for(let i=0;i<units.length;i++){
        const u = units[i];
        if(abs >= u.v){
          let val = Math.round(abs / u.v);
          if(val===1000 && i>0){ return sign + symbol + '1' + units[i-1].s; }
          return sign + symbol + String(val) + u.s;
        }
      }
      const i = Math.round(abs);
      const s = String(i).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      return sign + symbol + s;
    }
    function fmtEURsmart(n){
      const val = Number(n)||0;
      const abs = Math.abs(val);
      if(abs < 10_000){
        return fmtEUR0(val);
      }else if(abs < 100_000){
        const sign = val < 0 ? '-' : '';
        return sign + '€' + (abs/1000).toFixed(1) + 'k';
      }else{
        return fmtShortNoDec(val, '€');
      }
    }
    function fmtUSDshort(n){
      const sign = (n||0) < 0 ? '-' : '';
      const abs = Math.abs(Number(n)||0);
      const units = [
        {v:1e15,s:'q'},
        {v:1e12,s:'t'},
        {v:1e9,s:'b'},
        {v:1e6,s:'m'},
        {v:1e3,s:'k'}
      ];
      for(const u of units){
        if(abs >= u.v){
          let val = abs / u.v;
          const decimals = (abs < 100*u.v) ? 1 : 0;
          const str = val.toFixed(decimals).replace(/\.0$/,'');
          return sign + '$' + str + u.s;
        }
      }
      return fmtUSDintDot(n);
    }

    // State
    const state = {
      priceUSD: 0, priceEUR: 0, fxEURperUSD: 0,
      xrpHeld: 1200,
      overrideUSD: null,
      apyOverride: null,
      msVisible: false,
      priceSliderVisible: false,
      ltv: 0.30,
      decimals4: false
    };

    function setNow(){
      el('now').textContent = new Date().toLocaleString(undefined,{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
    }

    async function fetchPrices(){
      try{
        const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd,eur',{cache:'no-store'});
        if(!r.ok) throw 0;
        const j = await r.json();
        state.priceUSD = Number(j.ripple.usd);
        state.priceEUR = Number(j.ripple.eur);
        state.fxEURperUSD = state.priceEUR / (state.priceUSD || 1);
        el('source').textContent = state.overrideUSD!==null ? 'source: Override' : 'source: CoinGecko';
      }catch(e){
        try{
          const [usdR, eurR] = await Promise.all([
            fetch('https://api.coinbase.com/v2/prices/XRP-USD/spot',{cache:'no-store'}),
            fetch('https://api.coinbase.com/v2/prices/XRP-EUR/spot',{cache:'no-store'})
          ]);
          const usdJ = await usdR.json(), eurJ = await eurR.json();
          state.priceUSD = Number(usdJ.data.amount);
          state.priceEUR = Number(eurJ.data.amount);
          state.fxEURperUSD = state.priceEUR / (state.priceUSD || 1);
          el('source').textContent = state.overrideUSD!==null ? 'source: Override' : 'source: Coinbase';
        }catch(_){}
      }
      const po = el('priceOverride');
      if(po && !po.value){ po.placeholder = fmtUSDintDot(state.priceUSD); }
      render();
    }

    // APY model
    function blendedAPY(usdNotional){
      if(state.apyOverride!==null){
        const earn = usdNotional * state.apyOverride;
        return {earn, apyPct: state.apyOverride*100};
      }
      const t1 = Math.min(usdNotional, 10_000_000);
      const t2 = Math.max(usdNotional - 10_000_000, 0);
      const earn = t1*0.10 + t2*0.07;
      const apyPct = usdNotional>0 ? (earn/usdNotional)*100 : 0;
      return {earn, apyPct};
    }

    function usedUSDPrice(){ return (state.overrideUSD!==null) ? state.overrideUSD : state.priceUSD; }
    function setOverridePriceInt(p){ const pi = Math.max(1, Math.round(p||0));
      state.overrideUSD = pi;
      const po = el('priceOverride'); if(po && document.activeElement!==po) po.value = fmtUSDintDot(pi);
      el('source').textContent = 'source: Override';
      syncPriceSliderTo(pi);
      render();
    }

    function render(){
      const liveUSD = state.priceUSD;
      const liveEUR = state.priceEUR || (state.fxEURperUSD ? liveUSD * state.fxEURperUSD : 0);
      const usdFmt = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits: state.decimals4 ? 4 : 2, maximumFractionDigits: state.decimals4 ? 4 : 2});
      const eurFmt = new Intl.NumberFormat('nl-NL',{style:'currency',currency:'EUR',minimumFractionDigits: state.decimals4 ? 4 : 2, maximumFractionDigits: state.decimals4 ? 4 : 2});
      el('xrpUsdTile').textContent = usdFmt.format(liveUSD);
      el('xrpEur').textContent = eurFmt.format(liveEUR);
      el('eurHeld').textContent = fmtEUR0(liveEUR * state.xrpHeld);
      el('usdHeld').textContent = fmtUSDintDot(liveUSD * state.xrpHeld);

      const useUSD = usedUSDPrice();
      const portUsd = (state.xrpHeld || 0) * (useUSD || 0);
      const __pvTop = el('pvShortTop'); if(__pvTop){ __pvTop.textContent = fmtUSDshort(portUsd); }
      const _pvi = el('portfolioValInline'); if(_pvi) _pvi.textContent = fmtUSDintDot(portUsd);
      const pvs = el('portfolioValShort'); if(pvs) pvs.textContent = '('+fmtUSDshort(portUsd)+')';
      const inpPV = el('inpPortfolioVal');
      if(inpPV && document.activeElement !== inpPV){ inpPV.value = fmtUSDintDot(portUsd); }
      const pvTop = el('pvShortTop'); if(pvTop){ pvTop.textContent = fmtUSDshort(portUsd); }

      // Allocation
      const intXrp = Number(el('interestSlider').value);
      const loanXrp = state.xrpHeld - intXrp;
      const intUsd = intXrp * (useUSD||0);
      const loanUsd = loanXrp * (useUSD||0);
      el('intXrp').textContent = (intXrp).toLocaleString('en-US') + ' XRP';
      el('loanXrp').textContent = (loanXrp).toLocaleString('en-US') + ' XRP';
      el('intUsd').textContent = fmtUSDshort(intUsd);
      el('loanUsd').textContent = fmtUSDshort(loanUsd);
      el('loanAmount').textContent = 'Loan: ' + fmtUSDintDot(loanUsd*state.ltv);

      const {earn, apyPct} = blendedAPY(intUsd);
      el('apy').textContent = apyPct.toFixed(2)+'%';
      el('interestEarned').textContent = 'Interest: ' + fmtUSDintDot(earn);

      // Earnings derived
      const monthly = earn/12, weekly = earn/52, daily = earn/365, hourly = daily/24, minutely = hourly/60, secondly = minutely/60;
      const setIfIdle = (id,val)=>{ const n=el(id); if(n && document.activeElement!==n) n.value = fmtUSDintDot(val); };
      setIfIdle('inpMonthly', monthly);
      setIfIdle('inpWeekly',  weekly);
      setIfIdle('inpDaily',   daily);
      setIfIdle('inpHourly',  hourly);
      if(state.msVisible){
        setIfIdle('inpMinutely', minutely);
        setIfIdle('inpSecondly', secondly);
      }

      // Slider label
      const psVal = el('priceSliderVal'); if(psVal) psVal.textContent = fmtUSDintDot(usedUSDPrice());
      const pShort = el('priceShort'); if(pShort) pShort.textContent = fmtUSDshort(usedUSDPrice());
      const pShortE = el('priceShortEUR'); if(pShortE) pShortE.textContent = (state.fxEURperUSD? fmtEURsmart(usedUSDPrice()*state.fxEURperUSD) : '');
    }

    // Log slider mapping
    const SL_MIN=100, SL_MAX=1_000_000, SL_POS_MIN=0, SL_POS_MAX=1000;
    const lnMin=Math.log(SL_MIN), lnMax=Math.log(SL_MAX), lnSpan=lnMax-lnMin;
    function posToPrice(pos){ const t=clamp(pos,SL_POS_MIN,SL_POS_MAX)/SL_POS_MAX; const p=Math.exp(lnMin+t*lnSpan); let step=100; if(p>10000 && p<=100000) step=1000; else if(p>100000) step=10000; const q=Math.round(p/step)*step; return clamp(q,SL_MIN,SL_MAX); }
    function priceToPos(price){ const p=clamp(price,SL_MIN,SL_MAX); const t=(Math.log(p)-lnMin)/lnSpan; return Math.round(t*SL_POS_MAX); }
    function syncPriceSliderTo(price){ const sl=el('priceSlider'); if(!sl) return; const p=Number.isFinite(price)?price:10000; const pos=priceToPos(Math.min(p,1_000_000)); sl.value=String(pos); const psVal=el('priceSliderVal'); if(psVal) psVal.textContent=fmtUSDintDot(p); }

    function wirePriceControls(){
      const po=el('priceOverride'), btnApply=el('applyOverride'), btnLive=el('clearOverride');
      const btnSldr=el('togglePriceSlider'), priceArea=el('priceSliderArea'), sl=el('priceSlider');
      function applyFromInput(){ const v=parseMoneyStrict(po.value); if(Number.isFinite(v)&&v>0){ setOverridePriceInt(v); } else { state.overrideUSD=null; if(po) po.value=''; el('source').textContent='source: CoinGecko'; render(); } }
      if(po){
        po.addEventListener('input', ()=>{ const v=parseMoneyStrict(po.value); if(Number.isFinite(v)&&v>0){ state.overrideUSD=Math.max(1, Math.round(v)); el('source').textContent='source: Override'; syncPriceSliderTo(state.overrideUSD); } else { state.overrideUSD=null; el('source').textContent='source: CoinGecko'; } render(); });
        po.addEventListener('blur', ()=>{ const v=parseMoneyStrict(po.value); if(Number.isFinite(v)&&v>0){ state.overrideUSD=Math.max(1, Math.round(v)); po.value=fmtUSDintDot(state.overrideUSD); } else po.value=''; });
      }
      if(btnApply) btnApply.addEventListener('click', applyFromInput);
      if(btnLive) btnLive.addEventListener('click', ()=>{ state.overrideUSD=null; if(po) po.value=''; el('source').textContent='source: CoinGecko'; render(); });
      if(btnSldr){ btnSldr.addEventListener('click', ()=>{ state.priceSliderVisible=!state.priceSliderVisible; priceArea.style.display=state.priceSliderVisible?'block':'none'; if(state.priceSliderVisible){ const base=(state.overrideUSD!==null)?state.overrideUSD:10000; syncPriceSliderTo(base); } }); }
      if(sl){ sl.addEventListener('input', ()=>{ const price=posToPrice(Number(sl.value)); setOverridePriceInt(price); }); }
      const qp=el('quickPrice'); if(qp){ qp.addEventListener('click', (e)=>{ const v=e.target.getAttribute?.('data-price'); if(!v) return; setOverridePriceInt(Number(v)); }); }
    }

    function ensureInterestSide(){
      const intS=el('interestSlider'); const loanS=el('loanSlider');
      let v=Number(intS.value); if(v<=0){ v = Math.max(100, Math.round(state.xrpHeld/10)*10); intS.value=String(v); loanS.value=String(state.xrpHeld - v); }
      return v;
    }

    function setPriceForTargetAnnualEarn(targetAnnual){
      ensureInterestSide();
      const intUsdNeeded = (state.apyOverride!==null)
        ? (targetAnnual / (state.apyOverride || 0.000001))
        : (targetAnnual <= 1_000_000 ? targetAnnual/0.10 : 10_000_000 + (targetAnnual-1_000_000)/0.07);
      const intXrp = Number(el('interestSlider').value||1);
      const price = intUsdNeeded / intXrp;
      setOverridePriceInt(price);
    }

    function wireKpiInputs(){
      function attachCommit(id, compute){ const n=el(id); if(!n) return; n.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.currentTarget.blur(); } }); n.addEventListener('blur', (e)=>{ const v=parseMoneyStrict(e.target.value); if(Number.isFinite(v)&&v>0){ compute(v); e.target.value=fmtUSDintDot(v); } else { e.target.value=''; } }); }
      attachCommit('inpPortfolioVal', (usd)=>{ setOverridePriceInt(usd / (state.xrpHeld || 1)); });
      attachCommit('inpMonthly', (v)=> setPriceForTargetAnnualEarn(v*12));
      attachCommit('inpWeekly',  (v)=> setPriceForTargetAnnualEarn(v*52));
      attachCommit('inpDaily',   (v)=> setPriceForTargetAnnualEarn(v*365));
      attachCommit('inpHourly',  (v)=> setPriceForTargetAnnualEarn(v*24*365));
      attachCommit('inpMinutely',(v)=> setPriceForTargetAnnualEarn(v*60*24*365));
      attachCommit('inpSecondly',(v)=> setPriceForTargetAnnualEarn(v*60*60*24*365));
    }

    function wireLTVButtons(){
      const container = document.querySelector('.ltv-inline');
      if(!container) return;
      container.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-ltv]');
        if(!btn) return;
        state.ltv = Number(btn.getAttribute('data-ltv'));
        render();
      });
    }
    function wireAllocation(){
      const setBoth=(intVal)=>{ el('interestSlider').value=String(intVal); el('loanSlider').value=String(state.xrpHeld - intVal); render(); };
      el('interestSlider').addEventListener('input', (e)=>{ const v=clamp(Number(e.target.value),0,state.xrpHeld); setBoth(v); });
      el('loanSlider').addEventListener('input', (e)=>{ const v=clamp(Number(e.target.value),0,state.xrpHeld); setBoth(state.xrpHeld - v); });
      el('qx5').addEventListener('click', ()=> setBoth(300));
      el('qx10').addEventListener('click',()=> setBoth(600));
      el('qx15').addEventListener('click',()=> setBoth(900));
    }

    function wireMisc(){
      el('showMS').addEventListener('click', ()=>{
        state.msVisible = !state.msVisible;
        el('kpiMinutely').style.display = state.msVisible ? '' : 'none';
        el('kpiSecondly').style.display = state.msVisible ? '' : 'none';
        render();
      });
      el('apy5').addEventListener('click', ()=>{ state.apyOverride=0.05; render(); });
      const b75 = document.getElementById('apy7_5'); if(b75){ b75.addEventListener('click', ()=>{ state.apyOverride=0.075; render(); }); }
      el('apy10').addEventListener('click', ()=>{ state.apyOverride=0.10; render(); });
      el('apyReset').addEventListener('click', ()=>{ state.apyOverride=null; render(); });
    }

    
function wireRefreshButton(){
  const btn = document.getElementById('refreshBtn');
  if(!btn) return;
  btn.addEventListener('click', ()=> {
    fetchPrices();
  });
}


function wireDecimalsButton(){
  const btn = document.getElementById('toggleDecimals');
  if(!btn) return;
  btn.addEventListener('click', async ()=>{
    state.decimals4 = !state.decimals4;
    try{ await fetchPrices(); }catch(_){}
    render();
  })
;
}

function init(){
      setNow(); setInterval(setNow, 60_000);
      wirePriceControls();
      wireKpiInputs();
      wireAllocation();
      wireLTVButtons();
      wireMisc();
      wireRefreshButton();
      wireDecimalsButton();
      fetchPrices(); setInterval(fetchPrices, 60_000);
      render();
    }
    init();
  </script>

  
  <!-- TradingView Advanced Chart Widget -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    (function(){
      function mountWidget(symbol){
        if (!window.TradingView) return;
        // Clear container to fully remount
        var el = document.getElementById("tv_xrp_container");
        el.innerHTML = "";
        new TradingView.widget({
          autosize: true,
          symbol: symbol,
          interval: "60",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "8",                 // area/line-like style
          withdateranges: true,
          hide_side_toolbar: true,
          hide_legend: true,
          save_image: false,
          allow_symbol_change: false,
          studies: [],
          container_id: "tv_xrp_container",
          locale: "en",
          hide_volume: true
        });
        // Title text
        var title = document.querySelector(".tv-card-header .title");
        title.textContent = symbol.replace("BITSTAMP:","").replace("KRAKEN:","");
      }

      // initial
      var defaultSymbol = "BITSTAMP:XRPUSD";
      function ready(fn){document.readyState!=='loading'?fn():document.addEventListener('DOMContentLoaded',fn);}
      ready(function(){
        mountWidget(defaultSymbol);
        // controls
        var tvIsEUR=false;document.getElementById("btn_pair").addEventListener("click", function(){ tvIsEUR=!tvIsEUR; mountWidget(tvIsEUR? "BITSTAMP:XRPEUR":"BITSTAMP:XRPUSD"); }); document.getElementById("btn_usd_1.2k").addEventListener("click", function(){ mountWidget("BITSTAMP:XRPUSD*1200"); });
        document.getElementById("btn_eur_1.2k").addEventListener("click", function(){ mountWidget("BITSTAMP:XRPEUR*1200"); });
      });
    })();
  </script>

</body>
</html>
